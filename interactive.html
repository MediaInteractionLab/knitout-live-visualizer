<!DOCTYPE html>
<html>
<head>
<title>Test of knitout visualizer (3)</title>
</head>
<style>
code.knitout {
	display:block;
	height:10em;
	overflow:auto;
	background:#eee;
	border-radius:5px;
}
#dropTarget {
	position:fixed;
	left:0;
	bottom:0;
	width:100%;
	height:100%;

	background:#ccc;
	outline:4px dashed #eee;
	outline-offset:-20px;
	z-index:100;
	visibility:hidden;
}
#dropTarget.active {
	visibility:visible;
	background:#eee;
	outline-color:#ccc;
}
#file {
	display:none;
}
#fileLabel span {
	cursor:pointer;
	text-decoration:underline;
}

#show1 {
	width:100vh;
	height:80vh;
}

#editor-text {
	height:90vh;
	width:50vw;
}
#visualizer {
}

</style>
<body>
<input id="file" type="file" />
<label id="fileLabel" for="file"><span>Choose a knitout file</span> or drag one into the window to visualize it.</label>

<div id="editor">
<div id="editor-text">
/*
Paste your .js here
or drop a .js file to the page
or write some .js code
then click complie
want to see which lines generated a certain operation?
click the operation!
want to see which operations are generated by a certain line?
check "link line to boxes" next to "compile"
    
HAVE FUN!
*/

var knitout = require('../knitout-frontend-js/knitout');
k = new knitout.Writer({carriers:['1', '2', '3', '4', '5', '6', '7', '8', '9', '10']});

k.inhook('3');
for(var i=10; i>0; i--){
	if(i%2 == 0){
		k.tuck("-", "f", i,'3');
	}
}
for(var i=1; i&lt;=10; i++){
	if(i%2 != 0){
		k.tuck("+", "b", i, '3');
	}
}
k.outhook('3');
k.write('wristband.k');
</div>
<button id="compile">SHOW</button>
</div>

<div id="visualizer">
<canvas class="ShowKnitout" id="show"></canvas>
</div>

<div id="dropTarget"></div>

<script src="parseKnitout.js"></script>
<script src="CellMachine.js"></script>
<script src="VectorTiles.js"></script>
<script src="evalJS.js"></script>
<script src="show-knitout.js"></script>
<script src="./ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<script>

let editor = ace.edit("editor-text");
//themes are available here: https://github.com/ajaxorg/ace/tree/master/lib/ace/theme
editor.setTheme("ace/theme/tomorrow");
editor.session.setMode("ace/mode/javascript");

var show = document.getElementById('show');

show.showKnitout.clickLine = function(source) {
	console.log("Jump to: " + source);
	let line = parseInt(source);
	editor.gotoLine(line);
};

let oldHoveredRow = NaN;

show.showKnitout.highlightLine = function(source) {
	if (oldHoveredRow === oldHoveredRow) {
		editor.session.removeGutterDecoration(oldHoveredRow, "knitoutBox");
	}
	let line = parseInt(source);
	oldHoveredRow = line;
	if (line === line) {
		editor.session.addGutterDecoration(oldHoveredRow, "knitoutBox");
	} else {
		console.log("Unhighlight");
	}
};

let compile = document.getElementById("compile");
compile.addEventListener('click', function(){
	var code = editor.getValue();
	var knitout = evalJS(code);
	console.log(knitout);
	show.showKnitout.parse(knitout);

	/*
	console.log(knitout)
	var machine = new RecordMachine();
	parseKnitout(knitout, machine);
	boxes = initializeBoxes(machine,true,true,true,true,true);
	console.log(boxes);
	drawBoxes(boxes);
	console.log('done drawing');
	*/
});

function readFile(file) {
	console.log("Attempting to read file: '" + file.name + "'");

	var oldSize = 0;
	var oldCheck = 0;

	function pollFile() {
		//generate new data:
		var reader = new FileReader();
		reader.onload = function(){
			if (reader.result != code.innerText) {
				code.innerText = reader.result;
				show.showKnitout.reparse();
			}

			//poll again:
			readFile.pollTimeout = window.setTimeout(pollFile, 5000);
		};
		console.log("polling " + file.name);
		reader.readAsText(file);
	}

	if ('pollTimeout' in readFile) {
		window.clearTimeout(readFile.pollTimeout);
		delete readFile.pollTimeout;
	}
	pollFile();

}

var dropTarget = document.getElementById("dropTarget");
//dragging into the window also loads files:
dropTarget.addEventListener('dragover', function(evt){
	dropTarget.classList.add("active");
	evt.preventDefault();
	return false;
});
dropTarget.addEventListener('dragleave', function(evt){
	dropTarget.classList.remove("active");
	evt.preventDefault();
	return false;
});
dropTarget.addEventListener('drop', function(evt){
	dropTarget.classList.remove("active");
	try {
		readFile(evt.dataTransfer.files[0]);
	} catch (e) {
		console.log(e);
	}
	evt.preventDefault();
	return false;
});

//dragging into the window shows the target:
document.addEventListener('dragover', function(evt){
	dropTarget.classList.add("active");
	evt.preventDefault();
	return false;
});

var file = document.getElementById("file");
file.addEventListener('change', function(evt){
	try {
		readFile(file.files[0]);
	} catch (e) {
		console.log(e);
	}
	evt.preventDefault();
	return false;
});
</script>

</body>
