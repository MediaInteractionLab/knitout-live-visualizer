<!DOCTYPE html>
<html>
<head>
<title>Test of knitout visualizer (2)</title>
</head>
<style>
code.knitout {
	display:block;
	height:10em;
	overflow:auto;
	background:#eee;
	border-radius:5px;
}
#dropTarget {
	position:fixed;
	left:0;
	bottom:0;
	width:100%;
	height:100%;

	background:#ccc;
	outline:4px dashed #eee;
	outline-offset:-20px;
	z-index:100;
	visibility:hidden;
}
#dropTarget.active {
	visibility:visible;
	background:#eee;
	outline-color:#ccc;
}
#file {
	display:none;
}
#fileLabel span {
	cursor:pointer;
	text-decoration:underline;
}

#show1 {
	width:100vh;
	height:80vh;
}

</style>
<body>
<input id="file" type="file" />
<label id="fileLabel" for="file"><span>Choose a knitout file</span> or drag one into the window to visualize it.</label>

<p>Here's some example knitout code:</p>

<canvas class="ShowKnitout" id="show1" data-code="code1"></canvas>
<pre><code class="Knitout" id="code1">;!knitout-2
;;Carriers: A B C D

; tests for yarn carrier crossing

inhook A B C D
knit + f1 B
knit + f2 B
knit + f4 B
knit + f5 B
knit - f5 B

knit + f1 A
knit + f2 A
knit + f3 A
knit + f4 A
knit + f5 A

knit + f1 C
knit + f2 C
knit + f3 C
knit + f4 C
knit + f5 C

xfer f1 b1
xfer f2 b2
xfer f3 b3
xfer f4 b4
xfer f5 b5

knit + b1 A
knit + b2 A
knit + b3 A
knit + b4 A
knit + b5 A

knit + b1 C
knit + b2 C
knit + b3 C
knit + b4 C
knit + b5 C

xfer b1 f1
xfer b2 f2
xfer b3 f3
xfer b4 f4
xfer b5 f5

knit + f1 A C
knit + f2 A C
knit + f3 A C
knit + f4 A C
knit + f5 A C

xfer f1 b1
xfer f2 b2
xfer f3 b3
xfer f4 b4
xfer f5 b5

knit + b1 A C
knit + b2 A C
knit + b3 A C
knit + b4 A C
knit + b5 A C

xfer b1 f1
xfer b2 f2
xfer b3 f3
xfer b4 f4
xfer b5 f5

drop f1
drop f2
drop f3
drop f4
drop f5
</code></pre>

<div id="dropTarget"></div>

<script src="parseKnitout.js"></script>
<script src="CellMachine.js"></script>
<script src="VectorTiles.js"></script>
<script src="show-knitout.js"></script>

<script>

var code = document.getElementById('code1');
var show = document.getElementById('show1');

function readFile(file) {
	console.log("Attempting to read file: '" + file.name + "'");

	var oldSize = 0;
	var oldCheck = 0;

	function pollFile() {
		//generate new data:
		var reader = new FileReader();
		reader.onload = function(){
			if (reader.result != code.innerText) {
				code.innerText = reader.result;
				show.showKnitout.reparse();
			}

			//poll again:
			readFile.pollTimeout = window.setTimeout(pollFile, 5000);
		};
		console.log("polling " + file.name);
		reader.readAsText(file);
	}

	if ('pollTimeout' in readFile) {
		window.clearTimeout(readFile.pollTimeout);
		delete readFile.pollTimeout;
	}
	pollFile();

}

var dropTarget = document.getElementById("dropTarget");
//dragging into the window also loads files:
dropTarget.addEventListener('dragover', function(evt){
	dropTarget.classList.add("active");
	evt.preventDefault();
	return false;
});
dropTarget.addEventListener('dragleave', function(evt){
	dropTarget.classList.remove("active");
	evt.preventDefault();
	return false;
});
dropTarget.addEventListener('drop', function(evt){
	dropTarget.classList.remove("active");
	try {
		readFile(evt.dataTransfer.files[0]);
	} catch (e) {
		console.log(e);
	}
	evt.preventDefault();
	return false;
});

//dragging into the window shows the target:
document.addEventListener('dragover', function(evt){
	dropTarget.classList.add("active");
	evt.preventDefault();
	return false;
});

var file = document.getElementById("file");
file.addEventListener('change', function(evt){
	try {
		readFile(file.files[0]);
	} catch (e) {
		console.log(e);
	}
	evt.preventDefault();
	return false;
});
</script>

</body>
